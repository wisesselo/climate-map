<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Global Climate Map</title>
    <meta
      property="og:description"
      content="Visualize average monthly climate conditions"
    />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css"
    />
    <script src="nouislider.js"></script>
    <link
      href="slider.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@2.5.0/dist/index.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      html,
      body,
      #map {
        height: 100%;
      }

      #features {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 20%;
        overflow: scroll;
        background: rgba(255, 255, 255, 0.8);
      }
      #map canvas {
        cursor: crosshair;
      }

      .map-overlay {
        font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
        position: absolute;
        width: 25%;
        min-width: 290px;
        top: 0;
        left: 0;
        padding: 5px;
      }

      .map-overlay .map-overlay-inner {
        background-color: #fff;
        opacity: 0.9;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 5px;
      }

      [slider] {
        position: relative;
        width: 100%;
        height: 10px;
        margin: 28px 0 10px 0;
      }

      [slider] > div {
        position: relative;
        width: 100%;
      }

      [slider] > div > [inverse-left] {
        position: absolute;
        left: 0;
        height: 8px;
        background-color: #cccccc;
      }

      [slider] > div > [inverse-right] {
        position: absolute;
        right: 0;
        height: 8px;
        background-color: #cccccc;
      }

      [slider] > div > [range] {
        position: absolute;
        height: 8px;
        background-color: #ffe100;
      }

      [slider] > div > [thumb-left] {
        position: absolute;
        pointer-events: all;
        margin-right: 10px;
        top: -7px;
        height: 21px;
        width: 12px;
        cursor: not-allowed;
        background-color: #444444;
      }

      [slider] > div > [thumb-right] {
        position: absolute;
        pointer-events: all;
        margin-left: -10px;
        top: -7px;
        height: 21px;
        width: 12px;
        cursor: not-allowed;
        background-color: #444444;
      }

      [slider] > input[type="range"] {
        position: absolute;
        width: 100%;
        pointer-events: none;
        z-index: 3;
        height: 14px;
        opacity: 0;
      }

      div[slider] > input[type="range"]::-ms-thumb {
        pointer-events: all;
      }

      div[slider] > input[type="range"]::-moz-range-thumb {
        pointer-events: all;
      }

      div[slider] > input[type="range"]::-webkit-slider-thumb {
        pointer-events: all;
      }

      [slider] > div > [sign] {
        opacity: 1;
        position: absolute;
        top: -28px;
        z-index: 3;
        color: #000000;
        width: 28px;
        margin-left: -5px;
      }

      label {
        width: 1.2em;
    height: 1.2em;
      }

      input[type=radio] {
        position: absolute; 
        right: 15px;
    border: 0px;
    width: 1.2em;
    height: 1.2em;
}
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="map-input" class="map-overlay top">
      <div class="map-overlay-inner">
        <label>Darkest Month Solar Radiation (kJ/m²/day)</label> <input type="radio" name="fill-color-radio" id="solar-min-radio" checked>
        <div id="solar-min-slider" class="slider-class" style="margin: 30px 15px 15px 15px;"></div>
        <label>Brightest Month Solar Radiation (kJ/m²/day)</label> <input type="radio" name="fill-color-radio" id="solar-max-radio">
        <div id="solar-max-slider" class="slider-class" style="margin: 30px 15px 15px 15px;"></div>

        <label>Driest Month Precipitation (mm/month)</label> <input type="radio" name="fill-color-radio" id="precip-min-radio">
        <div id="precip-min-slider" class="slider-class" style="margin: 30px 15px 15px 15px;"></div>
        <label>Wettest Month Precipitation (mm/month)</label> <input type="radio" name="fill-color-radio" id="precip-max-radio">
        <div id="precip-max-slider" class="slider-class" style="margin: 30px 15px 15px 15px;"></div>

        <label>Coldest Month Mean Temperature (°C)</label> <input type="radio" name="fill-color-radio" id="mean-temp-min-radio">
        <div id="mean-temp-min-slider" class="slider-class" style="margin: 30px 15px 15px 15px;"></div>
        <label>Warmest Month Mean Temperature (°C)</label> <input type="radio" name="fill-color-radio" id="mean-temp-max-radio">
        <div id="mean-temp-max-slider" class="slider-class" style="margin: 30px 15px 15px 15px;"></div>

        <label>Coldest Month Mean Humidity (%)</label> <input type="radio" name="fill-color-radio" id="mean-rh-min-radio">
        <div id="mean-rh-min-slider" class="slider-class" style="margin: 30px 15px 15px 15px;"></div>
        <label>Warmest Month Mean Humidity (%)</label> <input type="radio" name="fill-color-radio" id="mean-rh-max-radio">
        <div id="mean-rh-max-slider" class="slider-class" style="margin: 30px 15px 15px 15px;"></div>
      </div>
      </div>
    </div>

    <pre id="features"></pre>
    <script type="module">
      //import {pmtiles} from "../pmtiles.js";
      let protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);

      const map = new maplibregl.Map({
        container: "map", // container id
        style: "style.json", // style URL
        center: [0, 0], // starting position [lng, lat]
        zoom: 1, // starting zoom
        minZoom: 1,
        maxZoom: 7,
      });

      function filterBy(
        solarMinLeftValue,
        solarMinRightValue,
        solarMaxLeftValue,
        solarMaxRightValue,
        preciMinLeftValue,
        preciMinRightValue,
        preciMaxLeftValue,
        preciMaxRightValue,
        tavMinLeftValue,
        tavMinRightValue,
        tavMaxLeftValue,
        tavMaxRightValue,
        rhMinLeftValue,
        rhMinRightValue,
        rhMaxLeftValue,
        rhMaxRightValue
      ) {
        const filters = [
          "all",
          [">=", "sol_min", solarMinLeftValue],
          ["<=", "sol_min", solarMinRightValue],
          [">=", "sol_max", solarMaxLeftValue],
          ["<=", "sol_max", solarMaxRightValue],
          [">=", "pre_min", preciMinLeftValue],
          ["<=", "pre_min", preciMinRightValue],
          [">=", "pre_max", preciMaxLeftValue],
          ["<=", "pre_max", preciMaxRightValue],
          [">=", "tav_min", tavMinLeftValue],
          ["<=", "tav_min", tavMinRightValue],
          [">=", "tav_max", tavMaxLeftValue],
          ["<=", "tav_max", tavMaxRightValue],
          [">=", "rh_tavmin", rhMinLeftValue],
          ["<=", "rh_tavmin", rhMinRightValue],
          [">=", "rh_tavmax", rhMaxLeftValue],
          ["<=", "rh_tavmax", rhMaxRightValue],
        ];
        map.setFilter("polygon-layer", filters);
      }

      // Constant value boundaries
      const SOLAR_MIN_LO = 0;
      const SOLAR_MIN_HI = 21014;
      const SOLAR_MAX_LO = 10964;
      const SOLAR_MAX_HI = 44561;
      const PRECIP_MIN_LO = 0;
      const PRECIP_MIN_HI = 476;
      const PRECIP_MAX_LO = 0;
      const PRECIP_MAX_HI = 2328;
      const TAV_MIN_LO = -68.1;
      const TAV_MIN_HI = 29;
      const TAV_MAX_LO = -35;
      const TAV_MAX_HI = 39.4;
      const RH_MIN_LO = 0;
      const RH_MIN_HI = 100;
      const RH_MAX_LO = 0;
      const RH_MAX_HI = 100;

      map.on("load", () => {
        map.addLayer({
          id: "polygon-layer",
          type: "fill",
          source: {
            type: "vector",
            url: "pmtiles://tiles/spth.pmtiles", //,"http://localhost:3000/filetest"
          },
          filter: ["==", "$type", "Polygon"],
          "source-layer": "spth",
          paint: {
            "fill-outline-color": "rgba(0,0,0,0)",
            "fill-color": [
              "interpolate",
              ["linear"],
              ["number", ["get", "sol_min"]],
              SOLAR_MIN_LO,
              "#000000",
              (SOLAR_MIN_LO+SOLAR_MIN_HI)/2,
              "#DAA520",
              SOLAR_MIN_HI,
              "#ffffff",
            ], //"#ffe100"
            "fill-opacity": 0.8,
          },
        });

        // map.addLayer({
        //   id: "point-layer",
        //   type: "circle",
        //   source: {
        //     type: "vector",
        //     url: "pmtiles://tiles/filenew.pmtiles",
        //   },
        //   filter: ["==", "$type", "Point"],
        //   "source-layer": "spt_minmax",
        //   paint: {
        //     "circle-radius": ["+", ["*", ["get", "SCALERANK"], -1], 10], /* [
        //       "interpolate",
        //       ["linear"],
        //       ["zoom"],
        //       2,
        //       ["*", ["+", ["*", ["get", "SCALERANK"], -1], 7], 0.6],
        //       6,
        //       ["+", ["*", ["get", "SCALERANK"], -1], 10],
        //     ], */
        //     "circle-color": "#B42222",
        //     "circle-opacity": 1
        //   },
        // });

        // Binding signature
        // solarMinSlider.noUiSlider.on('change', function () {
        //   const solarMinRightValue = solarMin.noUiSlider.get(true)[1];
        //   filterBy(
        //     0,
        //     solarMinRightValue,
        //     0,
        //     60000,
        //     0,
        //     9000,
        //     0,
        //     9000,
        //     -50,
        //     50,
        //     -50,
        //     50
        //   );
        //  });

        //document.getElementById("map-input").addEventListener("change", () => {

          
      });

      map.on("mousemove", (e) => {
        e.preventDefault();
        const features = map.queryRenderedFeatures(e.point);

        // Limit the number of properties we're displaying
        const displayProperties = ["properties", "id", "layer"];

        const displayFeatures = features.map((feat) => {
          const displayFeat = {};
          displayProperties.forEach((prop) => {
            displayFeat[prop] = feat[prop];
          });
          return displayFeat;
        });

        document.getElementById("features").innerHTML = JSON.stringify(
          displayFeatures,
          null,
          2
        );
      });



      // Solar
      var solarMinSlider = document.getElementById("solar-min-slider");

      noUiSlider.create(solarMinSlider, {
        start: [SOLAR_MIN_LO, SOLAR_MIN_HI],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: SOLAR_MIN_LO,
          max: SOLAR_MIN_HI,
        },
      });

      var solarMaxSlider = document.getElementById("solar-max-slider");

      noUiSlider.create(solarMaxSlider, {
        start: [SOLAR_MAX_LO, SOLAR_MAX_HI],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: SOLAR_MAX_LO,
          max: SOLAR_MAX_HI,
        },
      });

      // Precip
      var precipMinSlider = document.getElementById("precip-min-slider");

      noUiSlider.create(precipMinSlider, {
        start: [PRECIP_MIN_LO, PRECIP_MIN_HI],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: PRECIP_MIN_LO,
          max: PRECIP_MIN_HI,
        },
      });

      var precipMaxSlider = document.getElementById("precip-max-slider");

      noUiSlider.create(precipMaxSlider, {
        start: [PRECIP_MAX_LO, PRECIP_MAX_HI],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: PRECIP_MAX_LO,
          max: PRECIP_MAX_HI,
        },
      });

      // Mean Temp
      var meanTempMinSlider = document.getElementById("mean-temp-min-slider");

      noUiSlider.create(meanTempMinSlider, {
        start: [TAV_MIN_LO, TAV_MIN_HI],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: TAV_MIN_LO,
          max: TAV_MIN_HI,
        },
      });

      var meanTempMaxSlider = document.getElementById("mean-temp-max-slider");

      noUiSlider.create(meanTempMaxSlider, {
        start: [TAV_MAX_LO, TAV_MAX_HI],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: TAV_MAX_LO,
          max: TAV_MAX_HI,
        },
      });

      var meanRhMinSlider = document.getElementById("mean-rh-min-slider");

      noUiSlider.create(meanRhMinSlider, {
        start: [RH_MIN_LO, RH_MIN_HI],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: RH_MIN_LO,
          max: RH_MIN_HI,
        },
      });

      var meanRhMaxSlider = document.getElementById("mean-rh-max-slider");

      noUiSlider.create(meanRhMaxSlider, {
        start: [RH_MAX_LO, RH_MAX_HI],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: RH_MAX_LO,
          max: RH_MAX_HI,
        },
      });



      const sliders = document.getElementsByClassName("slider-class");
          
          for (var i = 0; i < sliders.length; i++) {
    sliders[i].noUiSlider.on("change", () => {
          filterBy(
            solarMinSlider.noUiSlider.get(true)[0],
            solarMinSlider.noUiSlider.get(true)[1],
            solarMaxSlider.noUiSlider.get(true)[0],
            solarMaxSlider.noUiSlider.get(true)[1],
            precipMinSlider.noUiSlider.get(true)[0],
            precipMinSlider.noUiSlider.get(true)[1],
            precipMaxSlider.noUiSlider.get(true)[0],
            precipMaxSlider.noUiSlider.get(true)[1],
            meanTempMinSlider.noUiSlider.get(true)[0],
            meanTempMinSlider.noUiSlider.get(true)[1],
            meanTempMaxSlider.noUiSlider.get(true)[0],
            meanTempMaxSlider.noUiSlider.get(true)[1],
            meanRhMinSlider.noUiSlider.get(true)[0],
            meanRhMinSlider.noUiSlider.get(true)[1],
            meanRhMaxSlider.noUiSlider.get(true)[0],
            meanRhMaxSlider.noUiSlider.get(true)[1]
          );
        });
}

            // Changing fill-color source
            document.getElementById("solar-min-radio").addEventListener("change", () => {
        map.setPaintProperty(
              'polygon-layer',
              'fill-color',
              [
              "interpolate",
              ["linear"],
              ["number", ["get", "sol_min"]],
              0,
              "#000000",
              5000,
              "#b59545",
              20000,
              "#FFD580",
              25000,
              "#ff0000",
              ]
            );
      })

      document.getElementById("solar-max-radio").addEventListener("change", () => {
        map.setPaintProperty(
              'polygon-layer',
              'fill-color',
              [
              "interpolate",
              ["linear"],
              ["number", ["get", "sol_max"]],
              0,
              "#000000",
              10000,
              "#b59545",
              25000,
              "#FFD580",
              30000,
              "#ff0000",
              ]
            );
      })

      document.getElementById("precip-min-radio").addEventListener("change", () => {
        map.setPaintProperty(
              'polygon-layer',
              'fill-color',
              [
              "interpolate",
              ["exponential", 0.99],
              ["number", ["get", "pre_min"]],
              0,
              "#F5DEB3",
              50,
              "#808000",
              450,
              "#2AAA8A",
              2250,
              "#00FFFF",
              ]
            );
      })

      document.getElementById("precip-max-radio").addEventListener("change", () => {
        map.setPaintProperty(
              'polygon-layer',
              'fill-color',
              [
              "interpolate",
              ["exponential", 0.99],
              ["number", ["get", "pre_max"]],
              0,
              "#F5DEB3",
              50,
              "#808000",
              450,
              "#2AAA8A",
              2250,
              "#00FFFF",
              ]
            );
      })

      document.getElementById("mean-temp-min-radio").addEventListener("change", () => {
        map.setPaintProperty(
              'polygon-layer',
              'fill-color',
              [
              "interpolate",
              ["exponential", 0.99],
              ["number", ["get", "tav_min"]],
              -30,
              "#000018",
              0,
              "#83bf54",
              40,
              "#ff5c5c",
              ]
            );
      })

      document.getElementById("mean-temp-max-radio").addEventListener("change", () => {
        map.setPaintProperty(
              'polygon-layer',
              'fill-color',
              [
              "interpolate",
              ["exponential", 0.99],
              ["number", ["get", "tav_max"]],
              -10,
              "#000018",
              10,
              "#83bf54",
              40,
              "#ff5c5c",
              ]
            );
      })

      document.getElementById("mean-rh-min-radio").addEventListener("change", () => {
        map.setPaintProperty(
              'polygon-layer',
              'fill-color',
              [
              "interpolate",
              ["exponential", 0.99],
              ["number", ["get", "rh_tavmin"]],
              20,
              "#F5DEB3",
              60,
              "#808000",
              100,
              "#2AAA8A",
              ]
            );
      })

      document.getElementById("mean-rh-max-radio").addEventListener("change", () => {
        map.setPaintProperty(
              'polygon-layer',
              'fill-color',
              [
              "interpolate",
              ["exponential", 0.99],
              ["number", ["get", "rh_tavmax"]],
              20,
              "#F5DEB3",
              60,
              "#808000",
              100,
              "#2AAA8A",
              ]
            );
      })


    </script>
  </body>
</html>
