<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Global Climate Map</title>
    <meta
      property="og:description"
      content="Visualize average monthly climate conditions"
    />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css"
    />
    <script src="nouislider.js"></script>
    <link
      href="slider.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@2.5.0/dist/index.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      html,
      body,
      #map {
        height: 100%;
      }

      #features {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 20%;
        overflow: scroll;
        background: rgba(255, 255, 255, 0.8);
      }
      #map canvas {
        cursor: crosshair;
      }

      .map-overlay {
        font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
        position: absolute;
        width: 25%;
        min-width: 290px;
        top: 0;
        left: 0;
        padding: 5px;
      }

      .map-overlay .map-overlay-inner {
        background-color: #fff;
        opacity: 0.9;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 5px;
      }

      [slider] {
        position: relative;
        width: 100%;
        height: 10px;
        margin: 28px 0 10px 0;
      }

      [slider] > div {
        position: relative;
        width: 100%;
      }

      [slider] > div > [inverse-left] {
        position: absolute;
        left: 0;
        height: 8px;
        background-color: #cccccc;
      }

      [slider] > div > [inverse-right] {
        position: absolute;
        right: 0;
        height: 8px;
        background-color: #cccccc;
      }

      [slider] > div > [range] {
        position: absolute;
        height: 8px;
        background-color: #ffe100;
      }

      [slider] > div > [thumb-left] {
        position: absolute;
        pointer-events: all;
        margin-right: 10px;
        top: -7px;
        height: 21px;
        width: 12px;
        cursor: not-allowed;
        background-color: #444444;
      }

      [slider] > div > [thumb-right] {
        position: absolute;
        pointer-events: all;
        margin-left: -10px;
        top: -7px;
        height: 21px;
        width: 12px;
        cursor: not-allowed;
        background-color: #444444;
      }

      [slider] > input[type="range"] {
        position: absolute;
        width: 100%;
        pointer-events: none;
        z-index: 3;
        height: 14px;
        opacity: 0;
      }

      div[slider] > input[type="range"]::-ms-thumb {
        pointer-events: all;
      }

      div[slider] > input[type="range"]::-moz-range-thumb {
        pointer-events: all;
      }

      div[slider] > input[type="range"]::-webkit-slider-thumb {
        pointer-events: all;
      }

      [slider] > div > [sign] {
        opacity: 1;
        position: absolute;
        top: -28px;
        z-index: 3;
        color: #000000;
        width: 28px;
        margin-left: -5px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="map-input" class="map-overlay top">
      <div class="map-overlay-inner">
        <label>Darkest Month Solar Radiation (kJ/m²/day) [fill-color]</label>
        <div id="solar-min-slider" style="margin: 30px 15px 15px 15px;"></div>
        <label>Brightest Month Solar Radiation (kJ/m²/day)</label>
        <div id="solar-max-slider" style="margin: 30px 15px 15px 15px;"></div>
      </div>
      <div class="map-overlay-inner">
        <label>Driest Month Precipitation (mm/month)</label>
        <div id="precip-min-slider" style="margin: 30px 15px 15px 15px;"></div>
        <label>Wettest Month Precipitation (mm/month)</label>
        <div id="precip-max-slider" style="margin: 30px 15px 15px 15px;"></div>
      </div>
      <div class="map-overlay-inner">
        <label>Coldest Month Mean Temperature (°C)</label>
        <div id="mean-temp-min-slider" style="margin: 30px 15px 15px 15px;"></div>
        <label>Warmest Month Mean Temperature (°C)</label>
        <div id="mean-temp-max-slider" style="margin: 30px 15px 15px 15px;"></div>
      </div>
      </div>
    </div>

    <pre id="features"></pre>
    <script type="module">
      //import {pmtiles} from "../pmtiles.js";
      let protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);

      const map = new maplibregl.Map({
        container: "map", // container id
        style: "https://demotiles.maplibre.org/style.json", // style URL
        center: [0, 20], // starting position [lng, lat]
        zoom: 2, // starting zoom
        minZoom: 1,
        maxZoom: 6,
      });

      function filterBy(
        solarMinLeftValue,
        solarMinRightValue,
        solarMaxLeftValue,
        solarMaxRightValue,
        preciMinLeftValue,
        preciMinRightValue,
        preciMaxLeftValue,
        preciMaxRightValue,
        tavMinLeftValue,
        tavMinRightValue,
        tavMaxLeftValue,
        tavMaxRightValue
      ) {
        const filters = [
          "all",
          [">=", "sol_min", solarMinLeftValue],
          ["<=", "sol_min", solarMinRightValue],
          [">=", "sol_max", solarMaxLeftValue],
          ["<=", "sol_max", solarMaxRightValue],
          [">=", "pre_min", preciMinLeftValue],
          ["<=", "pre_min", preciMinRightValue],
          [">=", "pre_max", preciMaxLeftValue],
          ["<=", "pre_max", preciMaxRightValue],
          [">=", "tav_min", tavMinLeftValue],
          ["<=", "tav_min", tavMinRightValue],
          [">=", "tav_max", tavMaxLeftValue],
          ["<=", "tav_max", tavMaxRightValue],
        ];
        map.setFilter("polygon-layer", filters);
      }

      map.on("load", () => {
        map.addLayer({
          id: "polygon-layer",
          type: "fill",
          source: {
            type: "vector",
            url: "pmtiles://tiles/filenew.pmtiles", //,"http://localhost:3000/filetest"
          },
          filter: ["==", "$type", "Polygon"],
          "source-layer": "spt_minmax",
          paint: {
            "fill-outline-color": "rgba(0,0,0,0)",
            "fill-color": [
              "interpolate",
              ["linear"],
              ["number", ["get", "sol_min"]],
              0,
              "#000000",
              25000,
              "#ffffff",
            ], //"#ffe100"
            "fill-opacity": 0.75,
          },
        });

        // map.addLayer({
        //   id: "point-layer",
        //   type: "circle",
        //   source: {
        //     type: "vector",
        //     url: "pmtiles://tiles/filenew.pmtiles",
        //   },
        //   filter: ["==", "$type", "Point"],
        //   "source-layer": "spt_minmax",
        //   paint: {
        //     "circle-radius": ["+", ["*", ["get", "SCALERANK"], -1], 10], /* [
        //       "interpolate",
        //       ["linear"],
        //       ["zoom"],
        //       2,
        //       ["*", ["+", ["*", ["get", "SCALERANK"], -1], 7], 0.6],
        //       6,
        //       ["+", ["*", ["get", "SCALERANK"], -1], 10],
        //     ], */
        //     "circle-color": "#B42222",
        //     "circle-opacity": 1
        //   },
        // });

        // Binding signature
        // solarMinSlider.noUiSlider.on('change', function () {
        //   const solarMinRightValue = solarMin.noUiSlider.get(true)[1];
        //   filterBy(
        //     0,
        //     solarMinRightValue,
        //     0,
        //     60000,
        //     0,
        //     9000,
        //     0,
        //     9000,
        //     -50,
        //     50,
        //     -50,
        //     50
        //   );
        //  });

        document.getElementById("map-input").addEventListener("mouseup", () => {
          filterBy(
            solarMinSlider.noUiSlider.get(true)[0],
            solarMinSlider.noUiSlider.get(true)[1],
            solarMaxSlider.noUiSlider.get(true)[0],
            solarMaxSlider.noUiSlider.get(true)[1],
            precipMinSlider.noUiSlider.get(true)[0],
            precipMinSlider.noUiSlider.get(true)[1],
            precipMaxSlider.noUiSlider.get(true)[0],
            precipMaxSlider.noUiSlider.get(true)[1],
            meanTempMinSlider.noUiSlider.get(true)[0],
            meanTempMinSlider.noUiSlider.get(true)[1],
            meanTempMaxSlider.noUiSlider.get(true)[0],
            meanTempMaxSlider.noUiSlider.get(true)[1]
          );
        });
        //   // Precipitation

        //   const preciMinLeftValue = parseInt(
        //     document.getElementById("pre_min_slider_left").value
        //   );
        //   let preciMinRightValue = parseInt(
        //     document.getElementById("pre_min_slider_right").value
        //   );
        //   if (preciMinRightValue >= 300) {
        //     preciMinRightValue = 9000;
        //   }

        //   const preciMaxLeftValue = parseInt(
        //     document.getElementById("pre_max_slider_left").value
        //   );
        //   let preciMaxRightValue = parseInt(
        //     document.getElementById("pre_max_slider_right").value
        //   );
        //   if (preciMaxRightValue >= 900) {
        //     preciMaxRightValue = 9000;
        //   }

        //   // Solar
        //   const solarMinLeftValue = parseInt(
        //     document.getElementById("sol_min_slider_left").value
        //   );
        //   let solarMinRightValue = parseInt(
        //     document.getElementById("sol_min_slider_right").value
        //   );
        //   if (solarMinRightValue >= 25000) {
        //     solarMinRightValue = 60000;
        //   }
        //   // solar nouislider
        //   solarMinRightValue = slider.noUiSlider.get(true)[1];

        //   const solarMaxLeftValue = parseInt(
        //     document.getElementById("sol_max_slider_left").value
        //   );
        //   let solarMaxRightValue = parseInt(
        //     document.getElementById("sol_max_slider_right").value
        //   );
        //   if (solarMaxRightValue >= 30000) {
        //     solarMaxRightValue = 60000;
        //   }

        //   // Temp
        //   let tavMinLeftValue = parseInt(
        //     document.getElementById("tav_min_slider_left").value
        //   );
        //   if (tavMinLeftValue <= -50) {
        //     tavMinLeftValue = -200;
        //   }
        //   let tavMinRightValue = parseInt(
        //     document.getElementById("tav_min_slider_right").value
        //   );
        //   if (tavMinRightValue >= 30) {
        //     tavMinRightValue = 60;
        //   }

        //   let tavMaxLeftValue = parseInt(
        //     document.getElementById("tav_max_slider_left").value
        //   );
        //   if (tavMaxLeftValue <= -20) {
        //     tavMaxLeftValue = -200;
        //   }
        //   let tavMaxRightValue = parseInt(
        //     document.getElementById("tav_max_slider_right").value
        //   );
        //   if (tavMaxRightValue >= 40) {
        //     tavMaxRightValue = 60;
        //   }

        //   filterBy(
        //     solarMinLeftValue,
        //     solarMinRightValue,
        //     solarMaxLeftValue,
        //     solarMaxRightValue,
        //     preciMinLeftValue,
        //     preciMinRightValue,
        //     preciMaxLeftValue,
        //     preciMaxRightValue,
        //     tavMinLeftValue,
        //     tavMinRightValue,
        //     tavMaxLeftValue,
        //     tavMaxRightValue
        //   );
        // });
      });

      map.on("mousemove", (e) => {
        const features = map.queryRenderedFeatures(e.point);

        // Limit the number of properties we're displaying for
        // legibility and performance
        const displayProperties = ["properties", "id", "layer"];

        const displayFeatures = features.map((feat) => {
          const displayFeat = {};
          displayProperties.forEach((prop) => {
            displayFeat[prop] = feat[prop];
          });
          return displayFeat;
        });

        document.getElementById("features").innerHTML = JSON.stringify(
          displayFeatures,
          null,
          2
        );
      });

      // Solar
      var solarMinSlider = document.getElementById("solar-min-slider");

      noUiSlider.create(solarMinSlider, {
        start: [0, 25000],
        step: 100,
        connect: true,
        tooltips: [true, true],
        range: {
          min: 0,
          max: 25000,
        },
      });

      var solarMaxSlider = document.getElementById("solar-max-slider");

      noUiSlider.create(solarMaxSlider, {
        start: [0, 45000],
        step: 100,
        connect: true,
        tooltips: [true, true],
        range: {
          min: 0,
          max: 45000,
        },
      });

      // Precip
      var precipMinSlider = document.getElementById("precip-min-slider");

      noUiSlider.create(precipMinSlider, {
        start: [0, 300],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: 0,
          max: 300,
        },
      });

      var precipMaxSlider = document.getElementById("precip-max-slider");

      noUiSlider.create(precipMaxSlider, {
        start: [0, 900],
        step: 1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: 0,
          max: 900,
        },
      });

      // Mean Temp
      var meanTempMinSlider = document.getElementById("mean-temp-min-slider");

      noUiSlider.create(meanTempMinSlider, {
        start: [-70, 30],
        step: 0.1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: -70,
          max: 30,
        },
      });

      var meanTempMaxSlider = document.getElementById("mean-temp-max-slider");

      noUiSlider.create(meanTempMaxSlider, {
        start: [-35, 40],
        step: 0.1,
        connect: true,
        tooltips: [true, true],
        range: {
          min: -35,
          max: 40,
        },
      });
    </script>
  </body>
</html>
